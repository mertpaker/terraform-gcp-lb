


Terraform is a tool for building, changing, and versioning infrastructure safely and efficiently. You can provision load balancers on GCP efficiently with Terraform.

In this tutorial, we will provision load balancer by using GCP Terraform modules.

https://cloud.google.com/load-balancing/docs/


## Objectives

* Learn about the load balancing modules for Terraform.
* [Create a Regional Network TCP load balancer.](#regional-network-load-balancer)
* Create a Regional Internal TCP load balancer.
* Create a global HTTP load balancer with Kubernetes Engine.
* [Create a global HTTPS content-based load balancer.](#global-https-content-based-load-balancer)




### Load Balancing modules for Terraform

A functional Load Balancer on GCP can be constructed by combining these elements
* Forwarding Rules
* Backend Services
* Target Pools
* URL maps
* Target Proxies

#### Changing Terraform version

We will use Terraform `v0.11.x` in this tutorial. If you have Terraform `v0.12.x` installed in your local environment or you use Cloud Shell (comes with Terraform `v0.12.x`), you should switch to Terraform `v0.11.x`.

If you have `tfswitch` installed in your environment, choose and switch to `v0.11.x` with this command:

```bash
tfswitch
```

Example Output:
```
Use the arrow keys to navigate: ↓ ↑ → ← 
? Select Terraform version: 
  ▸ 0.11.14 *recent
    0.12.3
    0.12.2
    0.12.1
↓   0.12.0
```

If `tfswitch` is not installed in your environment, install and configure `tfswitch` with these commands:

```bash
wget https://github.com/warrensbox/terraform-switcher/releases/download/0.7.737/terraform-switcher_0.7.737_linux_amd64.tar.gz
mkdir -p ${HOME}/bin
tar -xvf terraform-switcher_0.7.737_linux_amd64.tar.gz -C ${HOME}/bin
export PATH=$PATH:${HOME}/bin
tfswitch -b ${HOME}/bin/terraform 0.11.14
echo "0.11.14" >> .tfswitchrc
exit
```

The above command will terminate your shell connection. Open it again, then veify your Terraform version.

```bash
terraform version
```

Example Output:
```
Terraform v0.11.14
```


If you aren't using Cloud Shell, this tutorial uses the [default application credentials](https://cloud.google.com/docs/authentication/production) for Terraform authentication to GCP. Run the following command first to obtain the default credentials for your project.
```bash
gcloud auth application-default login
```


#### Clone the tutorial repository

In terminal, clone the terraform-gcp-lb repository:
```bash
git clone https://github.com/mertpaker/terraform-gcp-lb.git
```

Go into the `https-content-lb` directory
```bash
cd https-content-lb
```



## Regional Network Load Balancer

In this section, we will create a [Regional TCP Network Load Balancer](https://cloud.google.com/load-balancing/docs/network/) for regional load balancing across a managed instance group.

![alt text](./img/regional-lb-diagram.png "Regional Network Load Balancer")

**Figure 1.** `regional-lb` architecture diagram


![alt text](./img/terraform-google-lb-diagram.png "Terraform Regional Network Load Balancer")
**Figure x.** `terraform-google-lb` module Terraform resources diagram




## Global HTTPS Content-Based Load Balancer

This example creates an HTTPS load balancer to forward traffic to a custom URL map. The URL map sends traffic to the region closest to you with static assets being served from a Cloud Storage bucket. The TLS key and certificate is generated by Terraform using the [TLS provider](https://www.terraform.io/docs/providers/tls/index.html).


![alt text](img/global-https-content-lb-diagram.png "Global HTTPS Load Balancer")

**Figure 1.** `global-https-content-lb` architecture diagram

### Set up the environment

Go into the `https-content-lb` directory

```bash
cd https-content-lb
```


```
Apply complete! Resources: 48 added, 0 changed, 0 destroyed.

Outputs:

asset-url = https://34.98.69.45/assets/gcp-logo.svg
group1_region = us-west1
group2_region = us-central1
group3_region = us-east1
load-balancer-ip = 34.98.69.45
```

```bash
echo https://$(terraform output | grep load-balancer-ip | cut -d = -f2 | xargs echo -n)
```

Example Output:
```
https://34.98.69.45/
```

Destroy your resources 

```bash
terraform destroy
```

Example Output:
```
...

Destroy complete! Resources: 48 destroyed.

```